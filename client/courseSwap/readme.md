# 换课程序核心逻辑总结

本模块 (`./client/courseSwap`) 实现了自动化的换课辅助功能，包含核心业务逻辑与用户交互界面。以下是其核心设计与逻辑总结：

## 1. 双模式支持 (CLI & GUI)

程序设计了灵活的入口，能够根据运行环境或参数切换交互模式，但底层逻辑复用同一套核心代码。

* **命令行模式 (CLI)**: 基于 `cobra` 库实现 (`client/main.go`)。通过 `client.exe cli` 启动，提供交互式的问答流程（如输入文件路径、老师姓名等）。
* **图形界面模式 (GUI)**: 基于 `fyne` 库实现 (`client/run_windows.go`)。这是 Windows 下的默认启动模式。UI 包含文件选择器、日期选择器、下拉菜单以及左右分栏的布局（左侧操作，右侧日志与结果列表）。
* **核心复用**: 无论是 CLI 还是 GUI，最终都调用 `client/courseSwap` 包下的 `CalculateSwapCandidates`、`ExecuteSwap` 等函数执行业务逻辑。

## 2. 课程表源文件解析

* **解析器**: `client/courseSwap/parser.go` 使用 `excelize` 库读取 Excel 文件。
* **识别逻辑**: 程序并不假设固定的行号，而是遍历 Sheet 寻找关键字 "节次" 来定位每个老师的课表区域。
* **数据结构**: 解析结果被映射为 `teacherInfoMap`，包含老师姓名及其对应的静态课程列表（周几、第几节、班级、教室）。
* **冲突检测**: 解析过程中会校验同一老师在同一时间段是否有多门课程，防止源数据错误。

## 3. 从“静态课表”到“动态日程”的推演

这是非开发人员容易误解的核心难点。Excel 里的课表是**静态的、周期性**的（如“每周一第一节”），但换课是针对**具体日期**的（如“2024年1月1日的第一节”）。

* **时间投影**: `client/courseSwap/courseSwap.go` 中的逻辑会将静态的“周一至周五”映射到具体的日历日期上。
* **未来推演**: 程序会计算当前日期是周几，然后向后推演未来几周（代码中设定为 3 周或 21 天）的具体课程安排。
* **意义**: 只有将课程实例化为带日期的对象 (`CourseInfo` 包含 `Date` 字段)，才能实现“只换这一天的课，而不影响下周同一时间的课”。

## 4. 换课记录的存储与“回放”计算

换课不是修改 Excel 源文件，而是通过“叠加记录”的方式动态计算出来的。

* **存储层**: 支持本地 SQLite (`storageLocal.go`) 和云端 API (`storageCloud.go`) 两种存储方式，通过 `CourseSwapRepo` 接口统一调用。
* **计算逻辑**: 在计算候选课程时 (`CalculateSwapCandidates`)，程序会先加载内存中的基础课表，然后**读取并回放**所有的换课历史记录。
* **状态叠加**: 如果存在一条“A老师和B老师在X日期互换”的记录，程序会在内存中交换这两节课的属性。因此，用户看到的最终列表是**应用了所有历史换课记录后**的最新状态。
* **删除回滚**: 删除功能 (`DeleteSwapHistory`) 本质上是移除了这条记录，下次计算时不再应用该交换，从而实现逻辑上的“回滚”。

## 5. 参数缓存机制

为了提升用户体验，避免重复输入繁琐的路径和名字。

* **实现**: `client/courseSwap/input.go` 定义了 `InputConfig` 结构体和 `SaveCache`/`LoadCache` 方法。
* **持久化**: 参数被序列化为 JSON 文件 (`course_swap_cache.json`) 保存在本地。
* **应用**:
  * **CLI**: 在提示用户输入时，会显示缓存的值作为默认选项（直接回车即可使用）。
  * **GUI**: 启动时自动填充输入框、文件路径选择器和下拉菜单的选中项。
