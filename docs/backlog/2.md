# 造轮子

刚开始做这个库时，思路大致是：

新增一个表，将首先用gorm-gen生成数据库代码；

自己写个工具，生成一致的protobuf结构体，以及最基本的CURD接口定义；

再通过protoc生成接口代码，最后用kratos提供服务。

# sponge

然而最近了解到[sponge](https://github.com/zhufuyi/sponge/)这个库，基本上就是我想要的东西了。

而现在我自己写的CURD生成的工具还很粗糙，本来还打算慢慢迭代的，支持各个数据库的数据类型，支持复合键的查询接口，吧啦吧啦的。

接下来我们先试用sponge吧，依然还是同一个功能：

**“组织架构树”：一个用户，可以加入多个部门，在不同部门里分别担任不同的职位**

## 过程记录

### 准备
```shell
echo "export PATH=$PATH:/root/go/bin" > /etc/bashrc
echo "export PATH=$PATH:/root/go/bin" > /etc/profile

wget https://github.com/protocolbuffers/protobuf/releases/download/v28.1/protoc-28.1-linux-x86_64.zip
unzip protoc-28.1-linux-x86_64.zip
mv bin/protoc /usr/local/bin/
mv include/* /usr/local/include/
rm -rf bin include readme.txt protoc-28.1-linux-x86_64.zip
```

```shell
go install github.com/zhufuyi/sponge/cmd/sponge@latest
sponge init
```

### 使用sponge命令来生成代码
```shell
sponge web http \
--module-name=gogogo \
--server-name=service_user \
--project-name=gogogo \
--repo-addr= \
--db-driver=postgresql \
--db-dsn=gogogo:gogogo@192.168.101.8:5432/gogogo \
--db-table=user,user_job,user_dept,user_dept_assoc \
--embed=false \
--suited-mono-repo=true \
--extended-api=true
```

- 1：使用sponge run运行web服务，并生成代码
    - 不采用：每次都要开机要自己运行一下，还占用控制台窗口，懒得搞
    - sponge run --port=7050 --addr=http://127.0.0.1:7050
    - 注意了，addr是不能用0.0.0.0的，他不是listen，而是**web端访问服务端**的地址，想清楚你在哪里访问，你的服务又在哪里，什么样的地址能访问到
- 2：docker运行sponge，配置见docker/gogogo.yaml
    - 用docker长期运行，先从页面上交互操作
    - 能扒下来本地命令的话就本地运行
    - 比如[SQL-创建web服务-下载]可以从DevTools可以找到参数如下，则后续直接使用命令即可
        ```json
        {
            "path": "web-http",
            "arg": "web http --module-name=gogogo --server-name=service_user --project-name=gogogo --repo-addr= --db-driver=postgresql --db-dsn=gogogo:gogogo@192.168.101.8:5432/gogogo --db-table=user,user_job,user_dept,user_dept_assoc --embed=false --suited-mono-repo=true --extended-api=true"
        }
        ```
- 3：网页操作，通过pgsql已有的库生成代码，则service_user服务模块
    - gogogo:gogogo@192.168.101.8:5432/gogogo
    - 注意了，ip:port是**sponge服务端连接数据库**时用的

### 进一步生成user模块的文档
```shell
cd service_user
make docs
```

### 编译运行
```shell
make run
```

### 问题记录
- 表结构有一定要求
    - 失败后先手动build
        ```shell
        go build -o cmd/service_user/service_user cmd/service_user/main.go 
        ```
    - 报错1
        - user表对应代码生成了的注释不知道为什么换行了`// The name of /n the user`。
        - 原来是因为我user.sql定义了字段的COMMENT，里面就包含了换行
    - 报错2：
        - 生成的代码里要求model.UserDeptAssoc有id列
        - 则所有表都应该定义id自增列

- （未成功）修改端口8080->7060
    - 修改service_user/configs/service_user.yml
    - 好像没那么容易修改，应该都是用8080，然后通过docker来映射
    - 先放弃，把“新手教程”跑通，再回头研究怎么改端口

关于git提交：根据上面步骤已经运行起来了基本代码，为了理解不同步骤所生成的代码，分几次提交代码
- 非sponse相关的代码，提交一次
- sponge init生成的内容，应该是“web服务”相关，提交一次
- 在ui生成代码，提交一次
- make docs后，提交一次


